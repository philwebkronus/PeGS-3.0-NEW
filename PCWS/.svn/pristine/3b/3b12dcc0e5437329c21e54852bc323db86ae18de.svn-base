<?php

/**
 * Controller for ForceT Authentication webservice
 * @author gvjagolino,aqdepliyan,jefloresca,jdlachica,fdlsison
 */
class PcwsController extends Controller{
    
    public $_un; //username
    public $_dt; //accessdate
    public $_tkn; //token

    private function _authenticate(){
        $syscode = Yii::app()->params['SystemCode'];
        $onrequesttimeout = Yii::app()->params['onrequesttimeout'];
        $retval = 1;
        if(!empty($this->_un)){
            foreach ($syscode as $key => $value) {
                if($this->_un == $key){
                    $date1 = new DateTime($this->_dt);
                    $dt = $date1->format('YmdHis');
                    $processtkn = sha1($dt.$value);
                    if($this->_tkn == $processtkn){
                        if($onrequesttimeout){
                            $date2 = new DateTime(date('Y-m-d H:i:s'));
                            $diff = $date2->diff($date1);
                            $hours = $diff->h;
                            $hours = $hours + ($diff->days*24);

                            if($hours == 0){
                                $retval = 0;
                            } else { $retval = 2; }
                        } else { $retval = 0; }
                    } else { $retval = 1; }
                }
            }
        } else { $retval = 3; }
        
        return $retval;
    }
    
    public function actionDeposit(){
        Yii::import('application.components.CasinoController');

          $request = $this->_readJsonRequest();
          $this->_un = trim(trim($request['SystemUsername']));
          $this->_dt = trim(trim($request['AccessDate']));
          $this->_tkn = trim(trim($request['Token']));
                
          $isconnvalid = $this->_authenticate();

        if($isconnvalid == 0){
                $serviceid = trim(trim($request['ServiceID']));
                $cardnumber = trim(trim($request['CardNumber']));
                $amount = trim(trim($request['Amount']));
                $paymenttype = trim(trim($request['PaymentType']));
                $siteid = trim(trim($request['SiteID']));
                $aid = trim(trim($request['AID']));

                if(isset($serviceid) && $serviceid !== '' && isset($cardnumber) && $cardnumber !== '' && isset($amount) && $amount !== '' && isset($paymenttype) && $paymenttype !== '' && isset($siteid) && $siteid !== '' && isset($aid) && $aid !== ''){

                    $membercards = new MemberCardsModel();
                    $memberservices = new MemberServicesModel();
                    $ewallet = new EwallettransModel();
                    $terminalsessions = new TerminalSessionsModel();
                    $casinocontroller = new CasinoController();
                    $transactionsummarymodel = new TransactionSummaryModel();
                    $sitebalancemodel = new SiteBalanceModel();
                    
                    $mid = $membercards->getMID($cardnumber);

                   if(is_array($mid)){

                       $mid = $mid['MID'];

                       $terminalid = $terminalsessions->checkSessionIDwithcard($cardnumber, $serviceid);
                       if(is_array($terminalid)){
                            $terminalid = $terminalid['TerminalID'];
                       }
                       else{
                            $terminalid = null;
                       }

                       $casinocredentials = $memberservices->getCasinoCredentialsAbbott($mid);

                        if(!empty($casinocredentials) || !is_null($casinocredentials)){
                            $serviceUsername = $casinocredentials['ServiceUsername'];
                            $servicePassword = $casinocredentials['ServicePassword'];

                            $bcf = $sitebalancemodel->getSiteBalance($siteid);
                            $bcf = $bcf['Balance'];
                            var_dump($bcf);exit;
                            if(($bcf - $amount) < 0) {
                                $transMsg = 'Error: BCF is not enough.';
                                
                                $this->_sendResponse(200, CommonController::deposit($transMsg, 1));
                                exit;
                            }
                            
                            $balance = $casinocontroller->GetBalance($serviceUsername);
                            
                            if(is_array($balance)){
                                $playablebalance = $balance['balance'];
                            
                                $transsumid = $terminalsessions->getTransSummaryID($mid, $serviceid);

                                if(is_array($transsumid)){
                                    $transsumid = $transsumid['TransactionSummaryID'];
                                }
                                else{
                                    $transsumid = null;
                                }

                                $tracking1 = $ewallet->insertEwallet($cardnumber, $siteid, $mid, $amount, $playablebalance, 'D', $serviceid, 1, $paymenttype, $aid, $transsumid, $terminalid);
                                $tracking2 = 'D';
                                $tracking3 = $siteid;
                                $tracking4 = $siteid;
                                
                                if(!$tracking1){
                                    $transMsg = 'Deposit Failed, There was a pending transaction for this card.';

                                    $this->_sendResponse(200, CommonController::deposit($transMsg, 1));
                                    exit;
                                }

                                $resultdeposit = $casinocontroller->Deposit($serviceUsername, $servicePassword, 1, $amount, $tracking1, $tracking2, $tracking3, $tracking4);

                                if(is_null($resultdeposit)){
                                    $transSearchInfo = $casinocontroller->TransactionSerachInfo($serviceUsername, $tracking1, $tracking2, $tracking3, $tracking4);

                                    if(isset($transSearchInfo['TransactionInfo']))
                                    {
                                        //RTG / Magic Macau
                                        if(isset($transSearchInfo['TransactionInfo']['TrackingInfoTransactionSearchResult']))
                                        {
                                            $initial_deposit = $transSearchInfo['TransactionInfo']['TrackingInfoTransactionSearchResult']['amount'];
                                            $apiresult = $transSearchInfo['TransactionInfo']['TrackingInfoTransactionSearchResult']['transactionStatus'];
                                            $transrefid = $transSearchInfo['TransactionInfo']['TrackingInfoTransactionSearchResult']['transactionID'];
                                        }
                                        //MG / Vibrant Vegas
                                        elseif(isset($transSearchInfo['TransactionInfo']['MG']))
                                        {
                                            //$initial_deposit = $transSearchInfo['TransactionInfo']['MG']['Balance'];
                                            $transrefid = $transSearchInfo['TransactionInfo']['MG']['TransactionId'];
                                            $apiresult = $transSearchInfo['TransactionInfo']['MG']['TransactionStatus'];
                                        }
                                        //PT / PlayTech
                                        elseif(isset($transSearchInfo['TransactionInfo']['PT'])){
                                            //$initial_deposit = $transSearchInfo['TransactionInfo']['PT']['']; //need to ask if reported amount will be passed from PT
                                            $transrefid = $transSearchInfo['TransactionInfo']['PT']['id'];
                                            $apiresult = $transSearchInfo['TransactionInfo']['PT']['status'];
                                        }
                                    }
                                }
                                else{
                                    if(isset($resultdeposit['TransactionInfo'])){
                                        //RTG / Magic Macau
                                        if(isset($resultdeposit['TransactionInfo']['DepositGenericResult'])) {
                                            $transrefid = $resultdeposit['TransactionInfo']['DepositGenericResult']['transactionID'];
                                            $apiresult = $resultdeposit['TransactionInfo']['DepositGenericResult']['transactionStatus'];
                                            $apierrmsg = $resultdeposit['TransactionInfo']['DepositGenericResult']['errorMsg'];
                                        } 
                                        //MG / Vibrant Vegas
                                        else if(isset($resultdeposit['TransactionInfo']['MG'])) {
                                            $transrefid = $resultdeposit['TransactionInfo']['MG']['TransactionId'];
                                            $apiresult = $resultdeposit['TransactionInfo']['MG']['TransactionStatus'];
                                            $apierrmsg = $resultdeposit['ErrorMessage'];
                                        }
                                        //Rockin Reno
                                        else if(isset($resultdeposit['TransactionInfo']['PT'])) {
                                            $transrefid = $resultdeposit['TransactionInfo']['PT']['TransactionId'];
                                            $apiresult = $resultdeposit['TransactionInfo']['PT']['TransactionStatus'];
                                            $apierrmsg = $resultdeposit['TransactionInfo']['PT']['TransactionStatus'];
                                        }
                                    }
                                }

                                if($apiresult == 'TRANSACTIONSTATUS_APPROVED' || $apiresult == 'true' || $apiresult == 'approved') {
                                    $transstatus = '1';
                                } else {
                                    $transstatus = '2';
                                }

                                if ($apiresult == "true" || $apiresult == 'TRANSACTIONSTATUS_APPROVED' || $apiresult == 'approved'){

                                    $balance = $casinocontroller->GetBalance($serviceUsername);
                                    $playablebalance = $balance['balance'];
                                    
                                    if(!is_null($transsumid)){
                                        $totalamount = $transactionsummarymodel->getTotalReload($transsumid);
                                        if(is_array($totalamount)){
                                            $totalamount = $totalamount['WalletReload'] + $amount;
                                        }
                                        else{
                                            $totalamount = $amount;
                                        }
                                        $isupdatedtranssum = $transactionsummarymodel->updateTransSummary($totalamount, $transsumid);
                                        
                                        if(!$isupdatedtranssum){
                                            $transMsg = 'Failed to update Transaction Summary';

                                            $this->_sendResponse(200, CommonController::deposit($transMsg, 1));
                                            exit;
                                        }
                                    }

                                    $isupdatedewallet = $ewallet->updateEwallet($playablebalance, $transrefid, $apiresult, $aid, $transstatus, $tracking1);

                                if($isupdatedewallet){
                                    if($transstatus == 1){
                                        $playablebalance = number_format($playablebalance,2);
                                        $transMsg = 'Deposit Transaction Successful, The player initial playing balance is PhP '.$playablebalance;
                                        
                                        $sitebalancemodel->updateBcf($amount, $siteid, 'load');
                                        
                                        $memberservices->UpdateBalances($playablebalance, "load-$tracking1", $mid, $serviceid);
                                    }
                                    else{
                                        $transMsg = 'Deposit Transaction Failed';
                                    }
                                }
                                else{
                                    $transMsg = 'Failed to update in transaction Table';
                                }

                                $this->_sendResponse(200, CommonController::deposit($transMsg, 1));

                            } else {
                                $tobalance = '0.00';
                                $ewallet->updateEwallet($tobalance, null, $apiresult, $aid, $transstatus, $tracking1);

                                $transMsg = 'Deposit Transaction Failed';

                                $this->_sendResponse(200, CommonController::deposit($transMsg, 2));
                            }
                            }
                            else{
                                $transMsg = $balance; 
                                $errCode = 3;

                                $this->_sendResponse(200, CommonController::deposit($transMsg, $errCode));
                            }

                        }
                        else{
                            $transMsg = 'All fields are required'; 
                            $errCode = 3;

                            $this->_sendResponse(200, CommonController::deposit($transMsg, $errCode));
                        }

                   }
                   else{
                        $transMsg = 'Invalid card Number'; 
                        $errCode = 3;

                        $this->_sendResponse(200, CommonController::deposit($transMsg, $errCode));
                   }
                }
                else{
                    $transMsg = 'All fields are required'; 
                    $errCode = 3;

                    $this->_sendResponse(200, CommonController::deposit($transMsg, $errCode));
                }
        } else {
            switch ($isconnvalid) {
                case 1:
                    $transMsg = 'Authentication Failed: System does not have access right.'; 
                    break;
                case 2:
                    $transMsg = 'Authentication Failed: Unauthorized Access.'; 
                    break;
                case 3:
                    $transMsg = 'Authentication Failed: Invalid Username.'; 
                    break;
            }
            $errCode = $isconnvalid;
            $this->_sendResponse(200, CommonController::authenticate($transMsg, $errCode));
        }
    }
    
    
    public function actionGetbalance(){
        Yii::import('application.components.CasinoController');
        
        $request = $this->_readJsonRequest();
        $this->_un = trim(trim($request['SystemUsername']));
        $this->_dt = trim(trim($request['AccessDate']));
        $this->_tkn = trim(trim($request['Token']));
        
        $isconnvalid = $this->_authenticate();

        if($isconnvalid == 0){
                $cardnumber = trim(trim($request['CardNumber']));

                if($cardnumber !== ''){
                    $membercards = new MemberCardsModel();
                    $memberservices = new MemberServicesModel();

                    $mid = $membercards->getMID($cardnumber);

                    if(!empty($mid) || !is_null($mid)){
                        $mid = $mid['MID'];
                        
                        $terminalid = $terminalsessions->checkSessionIDwithcard($cardnumber, $serviceid);
                        $terminalid = $terminalid['TerminalID'];

                        $casinocredentials = $memberservices->getCasinoCredentialsAbbott($mid);

                        if(!empty($casinocredentials) || !is_null($casinocredentials)){
                            $serviceUsername = $casinocredentials['ServiceUsername'];

                            $casinocontroller = new CasinoController();

                            $balance = $casinocontroller->GetBalance($serviceUsername);

                            if(is_array($balance) && !empty($balance)){
                                $playablebalance = $balance['balance'];
                                $bonusbalance = $balance['bonusBalance'];
                                $compBalance = $balance['compBalance'];
                                $playthroughbal = $balance['playthroughBalance'];
                                $withdrawablebal = $playablebalance - $bonusbalance;
                                $transMsg = 'Success'; 
                                $errCode = 0;

                                $this->_sendResponse(200, CommonController::getbalance($playablebalance, $bonusbalance, $compBalance, $playthroughbal, $withdrawablebal, $transMsg, $errCode)); 
                            }
                            else{
                                $redeemablebalance = '';
                            $bonusbalance = '';
                            $compBalance = '';
                            $playthroughbal = '';
                            $withdrawablebal = '';
                            $transMsg = 'Cant get balance'; 
                            $errCode = 10;

                                $this->_sendResponse(200, CommonController::getbalance($redeemablebalance, $bonusbalance, $compBalance, $playthroughbal, $withdrawablebal, $transMsg, $errCode));
                            }

                        }
                        else{
                            $redeemablebalance = '';
                            $bonusbalance = '';
                            $compBalance = '';
                            $playthroughbal = '';
                            $withdrawablebal = '';
                            $transMsg = 'Casino credentials does not exist'; 
                            $errCode = 9;

                            $this->_sendResponse(200, CommonController::getbalance($redeemablebalance, $bonusbalance, $compBalance, $playthroughbal, $withdrawablebal, $transMsg, $errCode));
                        }

                    }
                    else{
                        $redeemablebalance = '';
                        $bonusbalance = '';
                        $compBalance = '';
                        $playthroughbal = '';
                        $withdrawablebal = '';
                        $transMsg = 'Account/Player does not exist'; 
                        $errCode = 8;

                        $this->_sendResponse(200, CommonController::getbalance($redeemablebalance, $bonusbalance, $compBalance, $playthroughbal, $withdrawablebal, $transMsg, $errCode));
                    }
                }
                else{
                    $redeemablebalance = '';
                    $bonusbalance = '';
                    $compBalance = '';
                    $playthroughbal = '';
                    $withdrawablebal = '';
                    $transMsg = 'All fields are required'; 
                    $errCode = 8;

                    $this->_sendResponse(200, CommonController::getbalance($redeemablebalance, $bonusbalance, $compBalance, $playthroughbal, $withdrawablebal, $transMsg, $errCode));
                }
        } else {
            switch ($isconnvalid) {
                case 1:
                    $transMsg = 'Authentication Failed: System does not have access right.'; 
                    break;
                case 2:
                    $transMsg = 'Authentication Failed: Unauthorized Access.'; 
                    break;
                case 3:
                    $transMsg = 'Authentication Failed: Invalid Username.'; 
                    break;
            }
            $errCode = $isconnvalid;
            $this->_sendResponse(200, CommonController::authenticate($transMsg, $errCode));
        }
    }
    
    
    public function actionWithdraw(){
        Yii::import('application.components.CasinoController');
        
          $request = $this->_readJsonRequest();
          $this->_un = trim(trim($request['SystemUsername']));
          $this->_dt = trim(trim($request['AccessDate']));
          $this->_tkn = trim(trim($request['Token']));
                
          $isconnvalid = $this->_authenticate();

        if($isconnvalid == 0){
                $serviceid = trim(trim($request['ServiceID']));
                $cardnumber = trim(trim($request['CardNumber']));
                $amount = trim(trim($request['Amount']));
                $siteid = trim(trim($request['SiteID']));
                $aid = trim(trim($request['AID']));

                if(isset($serviceid) && $serviceid !== '' && isset($cardnumber) && $cardnumber !== '' && isset($amount) && $amount !== '' && isset($siteid) && $siteid !== '' && isset($aid) && $aid !== ''){

                    $membercards = new MemberCardsModel();
                    $memberservices = new MemberServicesModel();
                    $ewallet = new EwallettransModel();
                    $terminalsessions = new TerminalSessionsModel();
                    $casinocontroller = new CasinoController();

                    $mid = $membercards->getMID($cardnumber);

                   if(is_array($mid)){

                       $mid = $mid['MID'];

                       $terminalid = $terminalsessions->checkSessionIDwithcard($cardnumber, $serviceid);
                       if(is_array($terminalid)){
                            $terminalid = $terminalid['TerminalID'];
                       }
                       else{
                            $terminalid = null;
                       }
                       
                       $casinocredentials = $memberservices->getCasinoCredentialsAbbott($mid);

                        if(!empty($casinocredentials) || !is_null($casinocredentials)){
                            $serviceUsername = $casinocredentials['ServiceUsername'];
                            $servicePassword = $casinocredentials['ServicePassword'];

                            $balance = $casinocontroller->GetBalance($serviceUsername);
                            if(is_array($balance)){
                                $playablebalance = $balance['balance'];
                                
                                if($amount > $playablebalance){
                                    $transMsg = 'Input amount is greater than exisitng balance.'; 
                                    $errCode = 3;

                                    $this->_sendResponse(200, CommonController::withdraw($transMsg, $errCode));
                                    exit;
                                }

                                $tracking1 = $ewallet->insertEwallet($cardnumber, $siteid, $mid, $amount, $playablebalance, 'W', $serviceid, 1, null, $aid, null, $terminalid);
                                $tracking2 = 'W';
                                $tracking3 = $siteid;
                                $tracking4 = $siteid;
                                
                                if(!$tracking1){
                                    $transMsg = 'Withdraw Failed, There was a pending transaction for this card.';

                                    $this->_sendResponse(200, CommonController::deposit($transMsg, 1));
                                    exit;
                                }
                                
                                $resultwithdraw = $casinocontroller->Withdraw($serviceUsername, $servicePassword, 1, $amount, $tracking1, $tracking2, $tracking3, $tracking4);

                                if(is_null($resultwithdraw)){
                                    $transSearchInfo = $casinocontroller->TransactionSerachInfo($serviceUsername, $tracking1, $tracking2, $tracking3, $tracking4);

                                    if(isset($transSearchInfo['TransactionInfo']))
                                    {
                                        //RTG / Magic Macau
                                        if(isset($transSearchInfo['TransactionInfo']['TrackingInfoTransactionSearchResult']))
                                        {
                                            $amount = abs($transSearchInfo['TransactionInfo']['TrackingInfoTransactionSearchResult']['amount']);
                                            $apiresult = $transSearchInfo['TransactionInfo']['TrackingInfoTransactionSearchResult']['transactionStatus'];
                                            $transrefid = $transSearchInfo['TransactionInfo']['TrackingInfoTransactionSearchResult']['transactionID'];
                                        }
                                        //MG / Vibrant Vegas
                                        elseif(isset($transSearchInfo['TransactionInfo']['MG']))
                                        {
                                            //$amount = abs($transSearchInfo['TransactionInfo']['Balance']); //returns 0 value
                                            $transrefid = $transSearchInfo['TransactionInfo']['MG']['TransactionId'];
                                            $apiresult = $transSearchInfo['TransactionInfo']['MG']['TransactionStatus'];
                                        }
                                        //PT / PlayTech
                                        if(isset($transSearchInfo['TransactionInfo']['PT'])){
                                            $transrefid = $transSearchInfo['TransactionInfo']['PT']['id'];
                                            $apiresult = $transSearchInfo['TransactionInfo']['PT']['status'];
                                        }
                                    }
                                }
                                else{
                                    //check Withdraw API Result
                                    if (isset($resultwithdraw['TransactionInfo'])) {
                                        //RTG / Magic Macau
                                        if(isset($resultwithdraw['TransactionInfo']['WithdrawGenericResult'])) {
                                            $transrefid = $resultwithdraw['TransactionInfo']['WithdrawGenericResult']['transactionID'];
                                            $apiresult = $resultwithdraw['TransactionInfo']['WithdrawGenericResult']['transactionStatus'];
                                        } 
                                        //MG / Vibrant Vegas
                                        if(isset($resultwithdraw['TransactionInfo']['MG'])) {
                                            $transrefid = $resultwithdraw['TransactionInfo']['MG']['TransactionId'];
                                            $apiresult = $resultwithdraw['TransactionInfo']['MG']['TransactionStatus'];
                                        }
                                        //PT / Rocking Reno
                                        if(isset($resultwithdraw['TransactionInfo']['PT'])) {
                                            $transrefid = $resultwithdraw['TransactionInfo']['PT']['TransactionId'];
                                            $apiresult = $resultwithdraw['TransactionInfo']['PT']['TransactionStatus'];
                                        }
                                    }
                                }

                                if ($apiresult == 'TRANSACTIONSTATUS_APPROVED' || $apiresult == 'true' || $apiresult == 'approved') {
                                    $transstatus = '1';
                                } else {
                                    $transstatus = '2';
                                }

                                if ($apiresult == "true" || $apiresult == 'TRANSACTIONSTATUS_APPROVED' || $apiresult == 'approved'){

                                    $balance = $casinocontroller->GetBalance($serviceUsername);
                                    $playablebalance = $balance['balance'];

                                $ewallet->updateEwallet($playablebalance, $transrefid, $apiresult, $aid, $transstatus, $tracking1);

                                $transMsg = 'You have successfully redeemed the amount of PhP '.$amount;

                                $memberservices->UpdateBalances($playablebalance, "withdraw-$tracking1", $mid, $serviceid);

                                $this->_sendResponse(200, CommonController::withdraw($transMsg, 1));

                            } else {
                                $tobalance = '0.00';
                                $ewallet->updateEwallet($tobalance, null, $apiresult, $aid, $transstatus, $tracking1);

                                $transMsg = 'Withdraw Transaction Failed';

                                $this->_sendResponse(200, CommonController::withdraw($transMsg, 2));
                            }
                            }
                            else{
                                $transMsg = $balance; 
                                $errCode = 3;

                                $this->_sendResponse(200, CommonController::withdraw($transMsg, $errCode));
                            }

                        }
                        else{
                            $transMsg = 'All fields are required'; 
                            $errCode = 3;

                            $this->_sendResponse(200, CommonController::withdraw($transMsg, $errCode));
                        }

                   }
                   else{
                        $transMsg = 'Invalid card Number'; 
                        $errCode = 3;

                        $this->_sendResponse(200, CommonController::withdraw($transMsg, $errCode));
                   }
                }
                else{
                    $transMsg = 'All fields are required'; 
                    $errCode = 3;

                    $this->_sendResponse(200, CommonController::withdraw($transMsg, $errCode));
                }
        } else {
            switch ($isconnvalid) {
                case 1:
                    $transMsg = 'Authentication Failed: System does not have access right.'; 
                    break;
                case 2:
                    $transMsg = 'Authentication Failed: Unauthorized Access.'; 
                    break;
            }
            $errCode = 1;
            $this->_sendResponse(200, CommonController::authenticate($transMsg, $errCode));
        }
    }
    
    public function actionGetCompPoints(){
        Yii::import('application.components.CasinoController');
        
        $request = $this->_readJsonRequest();
        $this->_un = trim(trim($request['SystemUsername']));
        $this->_dt = trim(trim($request['AccessDate']));
        $this->_tkn = trim(trim($request['Token']));
        
        $isconnvalid = $this->_authenticate();

        if($isconnvalid == 0){
                $compBalance = '';
                $cardnumber = trim(trim($request['CardNumber']));

                if(isset($cardnumber) && $cardnumber !== ''){
                    $membercards = new MemberCardsModel();
                    $memberservices = new MemberServicesModel();

                    $mid = $membercards->getMID($cardnumber);
                    if($mid){
                        $mid = $mid['MID'];

                        $casinocredentials = $memberservices->getCasinoCredentialsAbbott($mid);

                        if(!empty($casinocredentials) || !is_null($casinocredentials)){
                            $serviceUsername = $casinocredentials['ServiceUsername'];

                            $casinocontroller = new CasinoController();

                            $balance = $casinocontroller->GetBalance($serviceUsername);

                            if(is_array($balance) && !empty($balance)){    
                                $compBalance = $balance['compBalance'];
                                $transMsg = 'Success'; 
                                $errCode = 0;

                                $this->_sendResponse(200, CommonController::getcomppoints($transMsg, $errCode, $compBalance)); 
                            }
                            else{      
                                $transMsg = 'Cant get balance'; 
                                $errCode = 10;

                                $this->_sendResponse(200, CommonController::getcomppoints($transMsg, $errCode, $compBalance));
                            }
                        }
                        else {
                            $transMsg = 'Casino credentials does not exist'; 
                            $errCode = 9;

                            $this->_sendResponse(200, CommonController::getcomppoints($transMsg, $errCode, $compBalance));
                        }
                    }
                    else{
                        $transMsg = 'Account or Player does not exist'; 
                        $errCode = 8;

                        $this->_sendResponse(200, CommonController::getcomppoints($transMsg, $errCode, $compBalance));
                    }
                }
                else{
                    $transMsg = 'All fields are required'; 
                    $errCode = 3;

                    $this->_sendResponse(200, CommonController::getcomppoints($transMsg, $errCode, $compBalance));
                }
        } else {
            switch ($isconnvalid) {
                case 1:
                    $transMsg = 'Authentication Failed: System does not have access right.'; 
                    break;
                case 2:
                    $transMsg = 'Authentication Failed: Unauthorized Access.'; 
                    break;
                case 3:
                    $transMsg = 'Authentication Failed: Invalid Username.'; 
                    break;
            }
            $errCode = 1;
            $this->_sendResponse(200, CommonController::authenticate($transMsg, $errCode));
        }
    }
    
    public function actionAddCompPoints(){
        Yii::import('application.components.CasinoController');
        
        $request = $this->_readJsonRequest();
        $this->_un = trim(trim($request['SystemUsername']));
        $this->_dt = trim(trim($request['AccessDate']));
        $this->_tkn = trim(trim($request['Token']));
        
        $isconnvalid = $this->_authenticate();

        if($isconnvalid == 0){
                $cardnumber = trim(trim($request['CardNumber']));
                $amount = trim(trim($request['Amount']));
                $siteID = trim(trim($request['SiteID']));
                $serviceID = trim(trim($request['ServiceID']));


                if(isset($cardnumber) && $cardnumber !== '' && isset($amount) && $amount !== '' && isset($siteID) && $siteID !== '' && isset($serviceID) && $serviceID !== ''){
                    $membercards = new MemberCardsModel();
                    $memberservices = new MemberServicesModel();
                    $comppointslogs = new CompPointsLogsModel();
                    $terminalsessions = new TerminalSessionsModel();

                    $mid = $membercards->getMID($cardnumber);
                    if($mid){
                        if(is_float($amount)){
                            $mid = $mid['MID'];
                            
                            $terminalID = $terminalsessions->checkSessionIDwithcard($cardnumber, $serviceID);
                            $terminalID = $terminalID['TerminalID'];

                            $casinocredentials = $memberservices->getCasinoCredentialsAbbott($mid);

                            if(!empty($casinocredentials) || !is_null($casinocredentials)){
                                $serviceUsername = $casinocredentials['ServiceUsername'];

                                $casinocontroller = new CasinoController();

                                $result = $casinocontroller->AddToCurrentBalance($serviceUsername, $amount);

                                if(is_array($result) && !empty($result)){    
                                    $resultMsg = $result['Success'];
                                    //$resultCompBalance = $result['compsBalance'];
                                    if($resultMsg == 1) {
                                        $transMsg = 'Success'; 
                                        $errCode = 0;
                                        $comppointslogs->logEvent($mid, $cardnumber, $terminalID, $siteID, $serviceID, $amount, 'D');
                                    }
                                    else {
                                        $transMsg = 'Failure'; 
                                        $errCode = 1;
                                    }

                                    $this->_sendResponse(200, CommonController::addcomppoints($transMsg, $errCode)); 
                                }
                                else{      
                                    $transMsg = 'Cant add to current balance'; 
                                    $errCode = 12;

                                    $this->_sendResponse(200, CommonController::addcomppoints($transMsg, $errCode));
                                }
                            }
                            else {
                                $transMsg = 'Casino credentials does not exist'; 
                                $errCode = 9;

                                $this->_sendResponse(200, CommonController::addcomppoints($transMsg, $errCode));
                            }
                       }
                       else {
                            $transMsg = 'Amount should be decimal'; 
                            $errCode = 11;

                            $this->_sendResponse(200, CommonController::addcomppoints($transMsg, $errCode));
                       }
                    }
                    else{
                        $transMsg = 'Account or Player does not exist'; 
                        $errCode = 8;

                        $this->_sendResponse(200, CommonController::addcomppoints($transMsg, $errCode));
                    }     
                }
                else{
                    $transMsg = 'All fields are required'; 
                    $errCode = 3;

                    $this->_sendResponse(200, CommonController::addcomppoints($transMsg, $errCode));
                }   
        } else {
            switch ($isconnvalid) {
                case 1:
                    $transMsg = 'Authentication Failed: System does not have access right.'; 
                    break;
                case 2:
                    $transMsg = 'Authentication Failed: Unauthorized Access.'; 
                    break;
                case 3:
                    $transMsg = 'Authentication Failed: Invalid Username.'; 
                    break;
            }
            $errCode = 1;
            $this->_sendResponse(200, CommonController::authenticate($transMsg, $errCode));
        }
    }
    
    public function actionDeductCompPoints(){
        Yii::import('application.components.CasinoController');
        
        $request = $this->_readJsonRequest();
        $this->_un = trim(trim($request['SystemUsername']));
        $this->_dt = trim(trim($request['AccessDate']));
        $this->_tkn = trim(trim($request['Token']));
        
        $isconnvalid = $this->_authenticate();

        if($isconnvalid == 0){
            //todo
            $cardnumber = trim(trim($request['CardNumber']));
            $amount = trim(trim($request['Amount']));
            $siteid = trim(trim($request['SiteID']));
            if(isset($cardnumber) && $cardnumber !== '' && isset($amount) && $amount !== ''){
                empty($siteid) ? $siteid = NULL:$siteid=$siteid;
                $membercards = new MemberCardsModel();
                $memberservices = new MemberServicesModel();
                
                $mid = $membercards->getMID($cardnumber);
                if($mid){
                    $mid = $mid['MID'];
                    $casinocredentials = $memberservices->getCasinoCredentialsAbbott($mid);
                    if(!empty($casinocredentials) || !is_null($casinocredentials)){
                        $serviceusername = $casinocredentials['ServiceUsername'];
                        
                        $casinocontroller = new CasinoController();
                        $result = $casinocontroller->GetBalance($serviceusername);
                        $amount = 0;
                        //if((float)$result['compBalance'] > 0 && (float)$result['compBalance'] >= $amount){
                            $result = $casinocontroller->DeductToCurrentBalance($serviceusername, $amount);
                            var_dump($result);exit;
//                        } else {
//                            $transMsg = 'Account does not have sufficient points.'; 
//                            $errCode = 8;
//
//                            $this->_sendResponse(200, CommonController::deductcomppoints($transMsg, $errCode));
//                        }
                    } else {
                        $transMsg = 'Card does not have existing casino account.'; 
                        $errCode = 8;

                        $this->_sendResponse(200, CommonController::deductcomppoints($transMsg, $errCode));
                    }   
                } else {
                    $transMsg = 'Account or Player does not exist'; 
                    $errCode = 8;

                    $this->_sendResponse(200, CommonController::deductcomppoints($transMsg, $errCode));
                }   
            } else {
                $transMsg = 'All fields are required except for SiteID.'; 
                $errCode = 3;

                $this->_sendResponse(200, CommonController::deductcomppoints($transMsg, $errCode));
            }
        } else {
            switch ($isconnvalid) {
                case 1:
                    $transMsg = 'Authentication Failed: System does not have access right.'; 
                    break;
                case 2:
                    $transMsg = 'Authentication Failed: Unauthorized Access.'; 
                    break;
                case 3:
                    $transMsg = 'Authentication Failed: Invalid Username.'; 
                    break;
            }
            $errCode = 1;
            $this->_sendResponse(200, CommonController::authenticate($transMsg, $errCode));
        }
    }
    
     public function actionCheckpin()
    {
        $request = $this->_readJsonRequest();
        $this->_un = trim(trim($request['SystemUsername']));
        $this->_dt = trim(trim($request['AccessDate']));
        $this->_tkn = trim(trim($request['Token']));
        
        $isconnvalid = $this->_authenticate();

        if($isconnvalid == 0){
                $cardnumber = trim(trim($request['CardNumber']));
                $pin = trim(trim($request['PIN']));
                $membercards = new MemberCardsModel();
                $status = $membercards->getCardStatus($cardnumber);
                //Check if Card is Active
                if(intval($status) == 1 || intval($status) == 5)
                {
                    if(isset($cardnumber) && $cardnumber != "" && isset($pin) && $pin != "")
                    {
                        // Check IF PIN is Numeric and not more than 6 digits
                        if(is_numeric($pin) && strlen($pin) <= 6)
                        {
                            // Get MID by Card Number
                            $MID = $membercards->getMID($cardnumber);
                            // Get PIN by MID
                            $members = new MembersModel();
                            $memberpin = $members->getPIN2($MID['MID']);

                            if(sha1($pin) == $memberpin['PIN'])
                            {
                                $transMsg = 'PIN Code and Cardnumber matched.'; 
                                $errCode = 0;
                                $this->_sendResponse(200, CommonController::checkPin($transMsg, $errCode));
                            }
                            else
                            {
                                $transMsg = 'PIN code and Cardnumber does not match.'; 
                                $errCode = 1;
                                $this->_sendResponse(200, CommonController::checkPin($transMsg, $errCode));
                            }
                        }
                        else
                        {
                            $transMsg = 'PIN must be numeric and not greater than 6 digits.'; 
                            $errCode = 2;
                            $this->_sendResponse(200, CommonController::checkPin($transMsg, $errCode));
                        }

                    }
                    else{
                        $transMsg = 'All fields are required'; 
                        $errCode = 3;
                        $this->_sendResponse(200, CommonController::checkPin($transMsg, $errCode));
                    }
                }
                else 
                {
                    $transMsg = 'Card is Inactive.'; 
                    $errCode = 4;
                    $this->_sendResponse(200, CommonController::checkPin($transMsg, $errCode));
                }

                
        } else {
            switch ($isconnvalid) {
                case 1:
                    $transMsg = 'Authentication Failed: System does not have access right.'; 
                    break;
                case 2:
                    $transMsg = 'Authentication Failed: Unauthorized Access.'; 
                    break;
                case 3:
                    $transMsg = 'Authentication Failed: Invalid Username.'; 
                    break;
            }
            $errCode = 1;
            $this->_sendResponse(200, CommonController::authenticate($transMsg, $errCode));
        }
    }
    
    public function actionChangepin()
    {
        $request = $this->_readJsonRequest();
        $this->_un = trim(trim($request['SystemUsername']));
        $this->_dt = trim(trim($request['AccessDate']));
        $this->_tkn = trim(trim($request['Token']));
        
        $isconnvalid = $this->_authenticate();

        if($isconnvalid == 0){
                $actionCode = trim(trim($request['ActionCode']));
                $cardNumber = trim(trim($request['CardNumber']));
                $currentPin = trim(trim($request['CurrentPin']));
                $newPin = trim(trim($request['NewPin']));
                
                if(isset($actionCode) && $actionCode != "")
                {
                    // Get MID by Card Number
                    $membercards = new MemberCardsModel();
                    $MID = $membercards->getMID($cardNumber);
                    // Get PIN by MID
                    $members = new MembersModel();
                    $status = $membercards->getCardStatus($cardNumber);
                    // Check if Card is Active
                    if(intval($status) == 1 || intval($status) == 5)
                    {
                        // Reset PIN
                        if($actionCode == 0)
                        {
                            if(isset($cardNumber) && $cardNumber != "")
                            {
                                if($MID['MID'] == "" || $MID['MID'] > 0)
                                {
                                    $default = "1234";
                                    $reset = $members->updatePIN($MID['MID'], $default);

                                    if($reset == 1)
                                    {
                                        //Pin reset success
                                        $transMsg = 'PIN reset successful.'; 
                                        $errCode = 0;
                                        $this->_sendResponse(200, CommonController::changePin($transMsg, $errCode));
                                    }
                                    else
                                    {
                                        // Pin reset failed
                                        $transMsg = 'PIN reset failed.'; 
                                        $errCode = 1;
                                        $this->_sendResponse(200, CommonController::changePin($transMsg, $errCode));
                                    } 
                                }
                                else
                                {
                                    // Pin reset failed
                                    $transMsg = 'Invalid Cardnumber.'; 
                                    $errCode = 2;
                                    $this->_sendResponse(200, CommonController::changePin($transMsg, $errCode));
                                }

                            }
                            else
                            {
                                $transMsg = 'Please enter Cardnumber'; 
                                $errCode = 3;
                                $this->_sendResponse(200, CommonController::changePin($transMsg, $errCode));
                            }
                        }
                        else
                        {
                            // Change PIN
                            if(isset($currentPin) && $currentPin != "" && isset($newPin) && $newPin != "")
                            {
                                if(is_numeric($currentPin) && strlen($currentPin) <= 6 && is_numeric($newPin) && strlen($newPin) <= 6)
                                {
                                    // Change PIN
                                    // Validate current PIN
                                    $memberpin = $members->getPIN2($MID['MID']);
                                    if(sha1($currentPin) == $memberpin["PIN"])
                                    {
                                        // Check if New PIN and Current PIN is the same
                                        if(sha1($currentPin) == sha1($newPin))
                                        {
                                           $transMsg = 'New PIN and Current PIN is the same.'; 
                                           $errCode = 7;
                                           $this->_sendResponse(200, CommonController::changePin($transMsg, $errCode)); 
                                        }
                                        else
                                        {
                                            // Change PIN
                                            $changePIN = $members->updatePIN($MID['MID'], $newPin);
                                            if($changePIN == 1)
                                            {
                                                $transMsg = 'PIN successfully changed.'; 
                                                $errCode = 0;
                                                $this->_sendResponse(200, CommonController::changePin($transMsg, $errCode)); 
                                            }
                                            else
                                            {
                                                $transMsg = 'Change PIN failed.'; 
                                                $errCode = 1;
                                                $this->_sendResponse(200, CommonController::changePin($transMsg, $errCode)); 
                                            }
                                        }
                                    }
                                    else
                                    {
                                        $transMsg = 'Card Number and Current PIN does not match.'; 
                                        $errCode = 2;
                                        $this->_sendResponse(200, CommonController::changePin($transMsg, $errCode));
                                    }
                                }
                                else
                                {
                                    $transMsg = 'PIN must be numeric and not greater than 6 digits.'; 
                                    $errCode = 3;
                                    $this->_sendResponse(200, CommonController::changePin($transMsg, $errCode));
                                }
                            }
                            else
                            {
                                $transMsg = 'Please enter Current PIN and New PIN.'; 
                                $errCode = 4;
                                $this->_sendResponse(200, CommonController::changePin($transMsg, $errCode));
                            }
                        }
                    }
                    else
                    {
                        $transMsg = 'Card is Inactive.'; 
                        $errCode = 5;
                        $this->_sendResponse(200, CommonController::checkPin($transMsg, $errCode));
                    }
                    
                }
                else{
                    $transMsg = 'Please select an action.'; 
                    $errCode = 6;
                    $this->_sendResponse(200, CommonController::changePin($transMsg, $errCode));
                }
        } else {
            switch ($isconnvalid) {
                case 1:
                    $transMsg = 'Authentication Failed: System does not have access right.'; 
                    break;
                case 2:
                    $transMsg = 'Authentication Failed: Unauthorized Access.'; 
                    break;
                case 3:
                    $transMsg = 'Authentication Failed: Invalid Username.'; 
                    break;
            }
            $errCode = 1;
            $this->_sendResponse(200, CommonController::authenticate($transMsg, $errCode));
        }
    }
    
    
    private function _readJsonRequest() {

        //read the post input (use this technique if you have no post variable name):
        $post = file_get_contents("php://input");

        //decode json post input as php array:
        $data = CJSON::decode($post, true);

        return $data;
    }
    
    /**
     *
     * @param type $status
     * @param string $body
     * @param type $content_type 
     * @link http://www.yiiframework.com/wiki/175/how-to-create-a-rest-api
     */
    private function _sendResponse($status = 200, $body = '', $content_type = 'text/html') {
        // set the status
        $status_header = 'HTTP/1.1 ' . $status . ' ' . $this->_getStatusCodeMessage($status);
        header($status_header);
        // and the content type
        header('Content-type: ' . $content_type);

        // pages with body are easy
        if ($body != '') {
            // send the body
            echo $body;
        }
        // we need to create the body if none is passed
        else {
            // create some body messages
            $message = '';

            // this is purely optional, but makes the pages a little nicer to read
            // for your users.  Since you won't likely send a lot of different status codes,
            // this also shouldn't be too ponderous to maintain
            switch ($status) {
                case 401:
                    $message = 'You must be authorized to view this page.';
                    break;
                case 200:
                    $message = 'The requested URL ' . $_SERVER['REQUEST_URI'] . ' was not found.';
                    break;
                case 500:
                    $message = 'The server encountered an error processing your request.';
                    break;
                case 501:
                    $message = 'The requested method is not implemented.';
                    break;
            }

            // servers don't always have a signature turned on 
            // (this is an apache directive "ServerSignature On")
            $signature = ($_SERVER['SERVER_SIGNATURE'] == '') ? $_SERVER['SERVER_SOFTWARE'] . ' Server at ' . $_SERVER['SERVER_NAME'] . ' Port ' . $_SERVER['SERVER_PORT'] : $_SERVER['SERVER_SIGNATURE'];

            // this should be templated in a real-world solution
            $body = '
                    <!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
                    <html>
                    <head>
                        <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
                        <title>' . $status . ' ' . $this->_getStatusCodeMessage($status) . '</title>
                    </head>
                    <body>
                        <h1>' . $this->_getStatusCodeMessage($status) . '</h1>
                        <p>' . $message . '</p>
                        <hr />
                        <address>' . $signature . '</address>
                    </body>
                    </html>';

            echo $body;
        }
        //Yii::app()->end();
    }

    /**
     * HTTP Status Code Message
     * @param string $status
     * @return bool
     */
    private function _getStatusCodeMessage($status) {
        // these could be stored in a .ini file and loaded
        // via parse_ini_file()... however, this will suffice
        // for an example
        $codes = Array(
            200 => 'OK',
            400 => 'Bad Request',
            401 => 'Unauthorized',
            402 => 'Payment Required',
            403 => 'Forbidden',
            200 => 'Not Found',
            500 => 'Internal Server Error',
            501 => 'Not Implemented',
        );
        return (isset($codes[$status])) ? $codes[$status] : '';
    }
    
    
    /*
     * @author Jeremiah D. Lachica
     * @date January 29, 2015
     * @param string TerminalCode
     * @param int ServiceID
     * @param string CardNumber
     * @return JSON
     */
    
    
    public function actionUnlock(){
        $data = $this->_readJsonRequest();
        
        $transactionMessage = array(
            null=>'',
            0=>'Unlock Successful.',
            1=>'All fields are required.',
            2=>'Invalid input.',
            3=>'Invalid input parameter(s).',
            4=>'Terminal Code should consist of alphanumeric characters only.',
            5=>'Terminal code does not exist.',
            6=>'Service ID should consist of numeric characters only.',
            7=>'Service ID should contain numbers 18 or 19 only.',
            8=>'Card number should consist of alphanumeric characters only.',
            9=>'Terminal has pending transaction.',
            10=>'Service ID does not exist.',
            11=>'Card number does not exist.',
            12=>'Card number has an active session.',
            13=>"Unable to proceed because there's an active session",
            14=>'Cannot retrieve casino credentials.',
            15=>'Cannot connect to casino.',
            16=>'Failed to get SiteID.',
            17=>'Transaction failed.'
        );
        
        $eCode = null;
        $transMessage = null;
       
        if(isset($data['TerminalCode']) && isset($data['ServiceID'])
            && isset($data['CardNumber']) && isset($data['SystemUsername'])
            && isset($data['AccessDate']) && isset($data['AccessDate'])){
            
            $systemUsername = trim($data['SystemUsername']);
            $this->_un = trim($systemUsername);
            $this->_dt = trim(trim($data['AccessDate']));
            $this->_tkn = trim(trim($data['Token']));

            $isconnvalid = $this->_authenticate();

            if($isconnvalid == 0){
            
                $terminalCode = trim($data['TerminalCode']);
                $serviceID = trim($data['ServiceID']);
                $cardNumber = trim($data['CardNumber']);
            
                $validate = new BatchDataValidationHelper();
                $terminalsModel = new TerminalsModel();
                $terminalSessionsModel = new TerminalSessionsModel();
                $servicesModel = new ServicesModel();
                $memberCardsModel = new MemberCardsModel();
                $memberServicesModel = new MemberServicesModel();
                $eWalletModel = new CommonEWalletTransactionsModel();
                
                if($validate->isAllNotEmpty(array($terminalCode, $serviceID, $cardNumber, $systemUsername))){
                
                    if(ctype_alnum($terminalCode)){
                        $terminalID = Utilities::fetchFirstValue($terminalsModel->getTerminalID($terminalCode));
                        if($terminalID){
                            if(is_numeric($serviceID)){
                                if($serviceID==18 || $serviceID==19){
                                    if(ctype_alnum($cardNumber)){

                                        if(!Utilities::fetchFirstValue($terminalSessionsModel->isTerminalHasActiveSession($terminalID))){

                                            $userMode = Utilities::fetchFirstValue($servicesModel->getUserMode($serviceID));
                                            if($userMode){

                                                $mid = Utilities::fetchFirstValue($memberCardsModel->getMID($cardNumber));
                                                if($mid){
                                                    
                                                    if(!Utilities::fetchFirstValue($terminalSessionsModel->isCardHasActiveSession($cardNumber))){
                                                        
                                                        if(!Utilities::fetchFirstValue($terminalSessionsModel->isSessionActive($terminalID, $cardNumber))){
                                                            

                                                            $credentials = $memberServicesModel->getCasinoCredentialsCostelloAbbott($mid);
                                                            if( isset($credentials['ServiceUsername'])
                                                                && isset($credentials['ServicePassword'])
                                                                && isset($credentials['HashedServicePassword'])){

                                                                $serviceUsername = $credentials['ServiceUsername'];
                                                                $servicePassword = $credentials['ServicePassword'];
                                                                $hashedServicePassword = $credentials['HashedServicePassword'];
                                                                
                                                                $balance = $this->retrieveBalance($serviceUsername);
                                                              
                                                                
                                                                if($balance){
                                                                    
                                                                    $transactionReferenceID = Utilities::generateUDate('YmdHisu');
                                                                    $amount = '0';
                                                                    $transactionType='D';
                                                                    $siteID = Utilities::fetchFirstValue($terminalsModel->getSiteID($terminalID));
                                                                    $trackingID = '';
                                                                    $voucherCode='';
                                                                    $paymentType=1;
                                                                    $serviceTransactionID='';
                                                                    $deposit='0';
                                                                    $AID='1';

                                                                    if($siteID){
                                                                        $transactionResult = $eWalletModel->insert($mid, $terminalID, $serviceID, $cardNumber, $userMode, $serviceUsername, $servicePassword, $hashedServicePassword, $transactionReferenceID, $amount, $transactionType, $siteID, $trackingID, $voucherCode, $paymentType, $serviceTransactionID, $deposit, $AID, $balance);

                                                                        if($transactionResult){
                                                                            $eCode=0;//Unlock Successful.
                                                                        }else{
                                                                            $eCode=17;//Transaction Failed.
                                                                        }
                                                                    }else{
                                                                        $eCode=16;//Failed to get SiteID.
                                                                    }
                                                                }else{
                                                                    $eCode=15;//Cannot connect to casino.
                                                                }
                                                            }else{
                                                                $eCode=14;//Cannot retrieve casino credentials.
                                                            }
                                                        }else{
                                                            $eCode=13;//Unable to proceed because there's an active session.
                                                        }
                                                    }else{
                                                        $eCode=12;//Card number has an active session.
                                                    }
                                                }else{
                                                    $eCode=11;//Card number does not exist.
                                                }
                                            }else{
                                                $eCode=10;//Service ID does not exist.
                                            }
                                        }else{
                                            $eCode=9;//Terminal has pending transaction.
                                        }
                                    }else{
                                        $eCode=8; //Card number should consist of alphanumeric characters only. 
                                    }
                                }else{
                                    $eCode=7; //Card number should consist of alphanumeric characters only. 
                                }
                            }else{
                                $eCode = 6;//Service ID should consist of numeric characters only.
                            }
                        }else{
                            $eCode=5; //Terminal code does not exist.
                        }
                    }else{
                        $eCode = 4; //Terminal Code should consist of alphanumeric characters only.
                    }
                    
                }else{
                      $eCode = 1; //All fields are required.
                }
                $transMessage = $transactionMessage[$eCode];
                $this->_sendResponse(200, CommonController::unlock($transMessage, $eCode));
                
            }else{
                switch ($isconnvalid) {
                    case 1:
                        $transMsg = 'Authentication Failed: System does not have access right.'; 
                        break;
                    case 2:
                        $transMsg = 'Authentication Failed: Unauthorized Access.'; 
                        break;
                    case 3:
                        $transMsg = 'Authentication Failed: Invalid Username.'; 
                        break;
                }
                $errCode = 1;
                $this->_sendResponse(200, CommonController::authenticate($transMsg, $errCode));
            }
            
        }else{
            $eCode = 3; //ErrorMessage: Invalid input parameters.
            $transMessage = $transactionMessage[$eCode];
            $this->_sendResponse(200, CommonController::unlock($transMessage, $eCode));
        }
        
    }
    
   
       
    
    /*
     * @author Jeremiah D. Lachica
     * @date February 02, 2015
     * @param string TerminalCode
     * @param int ServiceID
     * @param string CardNumber
     * @return JSON
     */
    public function actionForceLogout(){
        $data = $this->_readJsonRequest();
        
        $transactionMessage = array(
            null=>'',
            0=>'Force Logout Successful.',
            1=>'All fields are required.',
            2=>'Invalid input.',
            3=>'Invalid input parameter(s).',
            4=>'Terminal Code should consist of alphanumeric characters only.',
            5=>'Terminal code does not exist.',
            6=>'Service ID should consist of numeric characters only.',
            7=>'Service ID should contain numbers 18 or 19 only.',
            8=>'Card number should consist of alphanumeric characters only.',
            9=>"Unable to proceed because there's no active terminal session.",
            10=>'Service ID does not exist.',
            11=>'Card number does not exist.',
            12=>'Card has no active session.',
            13=>'Cannot retrieve casino credentials.',
            14=>'Cannot get balance.',
            15=>"Unable to proceed because there's no active session",
            16=>'Failed to get SiteID.',
            17=>'Transaction failed.'
        );
        
        $eCode = null;
        $transMessage = null;
        
        if(isset($data['TerminalCode']) && isset($data['ServiceID'])
            && isset($data['CardNumber']) && isset($data['SystemUsername'])
            && isset($data['AccessDate']) && isset($data['AccessDate'])){
            
            $systemUsername = trim($data['SystemUsername']);
            $this->_un = trim($systemUsername);
            $this->_dt = trim(trim($data['AccessDate']));
            $this->_tkn = trim(trim($data['Token']));
            

            $isconnvalid = $this->_authenticate();

            if($isconnvalid == 0){
            
                $terminalCode = trim($data['TerminalCode']);
                $serviceID = trim($data['ServiceID']);
                $cardNumber = trim($data['CardNumber']);
                
                
                $validate = new BatchDataValidationHelper();
                $terminalsModel = new TerminalsModel();
                $terminalSessionsModel = new TerminalSessionsModel();
                $servicesModel = new ServicesModel();
                $memberCardsModel = new MemberCardsModel();
                $memberServicesModel = new MemberServicesModel();
                $eWalletModel = new CommonEWalletTransactionsModel();
                $casinocontroller = new CasinoController();
                

                if($validate->isAllNotEmpty(array($systemUsername, $terminalCode, $serviceID, $cardNumber))){
            
                    if(ctype_alnum($terminalCode)){
                        
                        $terminalID = Utilities::fetchFirstValue($terminalsModel->getTerminalID($terminalCode));
                        if($terminalID){
                            
                            if(is_numeric($serviceID)){
                                
                                if($serviceID==18 || $serviceID==19){
                                    
                                    if(ctype_alnum($cardNumber)){

                                        if(Utilities::fetchFirstValue($terminalSessionsModel->isTerminalHasActiveSession($terminalID))){

                                            $userMode = Utilities::fetchFirstValue($servicesModel->getUserMode($serviceID));
                                            if($userMode){

                                                $mid = Utilities::fetchFirstValue($memberCardsModel->getMID($cardNumber));
                                                if($mid){
                                                    
                                                    if(Utilities::fetchFirstValue($terminalSessionsModel->isCardHasActiveSession($cardNumber))){
                                                        
                                                        $credentials = $memberServicesModel->getCasinoCredentialsCostelloAbbott($mid);
                                                        if(isset($credentials['ServiceUsername'])){

                                                            $serviceUsername = $credentials['ServiceUsername'];
                                                            
                                                            
                                                            $balance = $this->retrieveBalance($serviceUsername);
                                                            
                                                            if($balance){
                                                               
                                                    
                                                                $transactionSummaryID = Utilities::fetchFirstValue($terminalSessionsModel->isSessionActive($terminalID, $cardNumber));
                                                                if($transactionSummaryID){
                                                                    $transactionReferenceID = Utilities::generateUDate('YmdHisu');
                                                                    $amount = 0;
                                                                    $transactionType='W';
                                                                    $siteID = Utilities::fetchFirstValue($terminalsModel->getSiteID($terminalID));
                                                                    $trackingID = '';
                                                                    $voucherCode='';
                                                                    $paymentType=1;
                                                                    $serviceTransactionID='';
                                                                    $AID='1';
                                                                    $withdrawal=0;

                                                                    if($siteID){

                                                                        $transactionResult = $eWalletModel->forceLogout($mid, $terminalID, $serviceID, $cardNumber, $userMode, $transactionReferenceID, $amount, $transactionType, $siteID, $trackingID, $voucherCode, $paymentType, $serviceTransactionID, $AID, $transactionSummaryID, $withdrawal);
                                                                        if($transactionResult){
                                                                            $eCode=0;//Unlock Successful.
                                                                        }else{
                                                                            $eCode=17;//Transaction Failed.
                                                                        }
                                                                    }else{
                                                                        $eCode=16;//Failed to get SiteID.
                                                                    }
                                                                }else{
                                                                    $eCode=15;//Unable to proceed because there's no active session.
                                                                }
                                                            }else{
                                                                $eCode=14;//Cannot get balance
                                                            }
                                                        }else{
                                                            $eCode=13;//Cannot retrieve casino credentials
                                                        }
                                                    }else{
                                                        $eCode=12;//Card has no active session.
                                                    }
                                                }else{
                                                    $eCode=11;//Card number does not exist.
                                                }
                                            }else{
                                                $eCode=10;//Service ID does not exist.
                                            }
                                        }else{
                                            $eCode=9;//Terminal has pending transaction.
                                        }
                                    }else{
                                        $eCode=8; //Card number should consist of alphanumeric characters only. 
                                    }
                                }else{
                                    $eCode=7; //Card number should consist of alphanumeric characters only. 
                                }
                            }else{
                                $eCode = 6;//Service ID should consist of numeric characters only.
                            }
                        }else{
                            $eCode=5; //Terminal code does not exist.
                        }
                    }else{
                        $eCode = 4; //Terminal Code should consist of alphanumeric characters only.
                    }
                }else{
                    $eCode = 1; //All fields are required.  
                }
                
                $transMessage = $transactionMessage[$eCode];
                $this->_sendResponse(200, CommonController::forceLogout($transMessage, $eCode));
            }else{
                switch ($isconnvalid) {
                    case 1:
                        $transMsg = 'Authentication Failed: System does not have access right.'; 
                        break;
                    case 2:
                        $transMsg = 'Authentication Failed: Unauthorized Access.'; 
                        break;
                    case 3:
                        $transMsg = 'Authentication Failed: Invalid Username.'; 
                        break;
                }
                $errCode = 1;
                $this->_sendResponse(200, CommonController::authenticate($transMsg, $errCode));
            }
            
        }else{
            $eCode = 3; //ErrorMessage: Invalid input parameters.
            $transMessage = $transactionMessage[$eCode];
            $this->_sendResponse(200, CommonController::forceLogout($transMessage, $eCode));
        }
    }
    
    private function retrieveBalance($serviceUsername){
        $casinocontroller = new CasinoController();
        $balance = null;
        $numberOfAttempts = 3;
        $attempts=0;

        while($attempts<$numberOfAttempts){
            $balances = $casinocontroller->GetBalance($serviceUsername); 
            if(is_array($balances) && !empty($balances)){
                $balance = $balances['balance'];
                $attempts = 5;
            }else{
                $attempts++;
            }
        }
        return $balance;
    }
    
}
?>
